---

- name: Clean yum cache
  command: /usr/bin/yum clean all

- name: Restart journald
  systemd:
    name: systemd-journald
    state: restarted
  listen: Restart journald

- name: Restart Kubelet
  systemd:
    name: kubelet
    state: restarted
    daemon_reload: yes
  listen: Restart kubelet

# We use the previously saved kubeconfig to be able
# to apply patches on worker nodes as well.
- name: Apply kubelet-config patches
  ansible.builtin.shell: |
    set -o pipefail &&
    echo "{{ k8s_admin_conf }}" |
    kubeadm upgrade node phase kubelet-config --patches {{ kubelet_config_path }}/patches/ --kubeconfig /dev/stdin
  changed_when: false
  any_errors_fatal: true
  listen: Apply kubelet-config patches
